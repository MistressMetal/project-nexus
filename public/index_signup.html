<!--Header-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIU HCPA Member Portal</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#794C99" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Project Nexus" />
    <link rel="apple-touch-icon" href="/icons/small.png" />
    <link rel="icon" type="image/x-icon" href="/icons/tiny.png">
</head>
<body>
    <div class="container">
        <div class="content">
                <div class="form-section">
                    <h2>Request Hub Access</h2>
                    <p style="margin-bottom: 20px;">Submit a request to join the Chapter Hub. Leadership will review your application.</p>
                    <form id="requestForm">
                        <div class="form-group">
                            <label for="requestEmail">Email:</label>
                            <input type="text" id="requestEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="requestFirst">First Name:</label>
                            <input type="text" id="requestFirst" required>
                        </div>
                        <div class="form-group">
                            <label for="requestLast">Last Name:</label>
                            <input type="text" id="requestLast" required>
                        </div>
                        <div class="form-group">
                            <label for="selectChapter">Select Chapter</label>
                            <select name="selectChapter" id="selectChapter" required>
                                <option value="">loading...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="requestPassword">Password:</label>
                            <input type="password" id="requestPassword" minlength="8" required>
                        </div>
                        <div class="form-group">
                            <label for="requestPasswordConfirm">Confirm Password:</label>
                            <input type="password" id="requestPasswordConfirm" minlength="8" required>
                        </div>
    

                        <button type="submit" id="submitBtn">Submit Request</button>

                    </form>
                    <div id="errorMessage" style="color: #8B0000; margin-top: 10px; display: none;"></div>
                    <div id="successMessage" style="color: #28a745; margin-top: 10px; display: none;"></div>

                </div> <!--Form-->
                <p>Already registered? <a href="index.html">Log in</a> or <a href="reset.html">reset your password</a>.</p>
        </div> <!--Content-->
    </div><!--container-->


</body>
<script src="/app.js" type="module"></script>
<script type="module">

    if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('ServiceWorker registered'))
                .catch(err => console.error('ServiceWorker registration failed:', err));
        }

    document.addEventListener("DOMContentLoaded", loadChapters);

    document.getElementById('requestForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const requestForm = document.getElementById('requestForm');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
    const firstName = document.getElementById('requestFirst').value.trim();
    const lastName = document.getElementById('requestLast').value.trim();
    const email = document.getElementById('requestEmail').value.trim();
    const chapter = document.getElementById('selectChapter').value;
    const password = document.getElementById('requestPassword').value;
    const passwordConfirm = document.getElementById('requestPasswordConfirm').value;

    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';

    if (!firstName || !lastName || !email || !chapter || !password) {
            showError('Please fill in all fields');
            return;
            }

    if (password !== passwordConfirm) {
        showError('Passwords do not match');
        return;
            }

    if (password.length < 8) {
            showError('Password must be at least 8 characters');
            return;
            }

//    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {

    // Check for existing user
    const {data: existingUsers, error: checkError } = await supabase
        .from('profiles')
        .select('id')
        .eq('email', email);

        if (checkError) throw checkError;


    
    if (existingUsers && existingUsers.length > 0) {
        alert("This email is already registered. Please log in or reset your password.");
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Request';
        return; 
    }

        const { data: authData, error: signUpError } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
    data: {
      first_name: firstName,
      last_name: lastName,
      chapter: chapter
    }
  }
        });

        if (signUpError) throw signUpError; 

        showSuccess('Signup successful! You will be able to sign in once an admin approves you.');

        requestForm.reset();

        setTimeout(() => {
            window.location.href = 'index.html';
        }, 5000);

    } catch (error) {
        console.error('Caught error:', error);
        showError(getErrorMessage(error));
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Request';
    }
});

function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function getErrorMessage(error) {
            if (error.message.includes('already registered')) {
                return 'This email is already registered';
            } else if (error.message.includes('invalid email')) {
                return 'Please enter a valid email address';
            } else if (error.message.includes('weak password')) {
                return 'Password is too weak. Use at least 8 characters with a mix of letters and numbers.';
            } else if (error.message.includes('network')) {
                return 'Network error. Please check your connection.';
            }
            return 'Signup failed. Please try again.';
        }});
</script>