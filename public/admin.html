<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Chapter Hub Management</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#FFED00" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Project Nexus" />
    <link rel="apple-touch-icon" href="/icons/small.png" />
    <link rel="icon" type="image/x-icon" href="/icons/favicon.png">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>‚öôÔ∏è Admin Panel</h1>
                <p>Hub Management Dashboard</p>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>

        <div class="content">
            <div id="message" class="message"></div>

            <!-- Auth Required Message -->
            <div id="authRequired" class="auth-required" style="display: none;">
                <h2>üîí Admin Access Required</h2>
                <p>You need to be logged in as an administrator to access this panel.</p>
                <button onclick="window.location.href='/admin-login'">Go to Admin Login</button>
            </div>

            <!-- Admin Content -->
            <div id="adminContent" style="display: none;">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('requests')">Access Requests</button>
                    <button class="tab" onclick="switchTab('members')">Manage Members</button>
                    <button class="tab" onclick="switchTab('announcements')">Manage Announcements</button>
                </div>

                <!-- Access Requests Tab -->
                <div id="requestsTab" class="tab-content active">
                    <h2 style="margin-bottom: 20px;">Pending Access Requests</h2>
                    <div id="requestsList"></div>
                </div>

                <!-- Members Tab -->
                <div id="membersTab" class="tab-content">
                    <h2 style="margin-bottom: 20px;">All Members</h2>
                    <div style="overflow-x: auto;">
                        <table id="membersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Member Since</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody"></tbody>
                        </table>
                    </div>
                    </div>
                <!-- Announcement Tab-->
                    <div id="announcementsTab" class="tab-content">
                        <div id="announcementsID">
                            <h2 style="margin-bottom: 20px;">Post an Announcment for All Users</h2>
                            <label for="announcementType">Category of Announcement</label>
                            <select name="announcementType" id="announcementType">
                                <option value="unionUpdate">SEIU HCPA Update</option>
                                <option value="chapterUpdate">Chapter Update</option>
                                <option value="facilityUpdate">Facility Update</option>
                                <option value="priorityUpdate">Priority</option>
                                <option value="negotiationUpdate">Bargaining Update</option>
                                <option value="socialActivity">Social Activities</option>
                            </select>
                            <br>
                            <p><input type="text" id="postedBy" placeholder="Posted By"></p>
                            <br>
                            <p><input type="text" id="newAnnouncement" placeholder="Announcement"></p>
                        
                        
                        <button id="addAnnouncementButton">Add Announcement</button>
                        <div id="announcementPosted"></div>
                     </div>
                <div>
                    <br>
                    <h3>View Announcements</h3>
                    <label for="announcementTypeFilter">Category of Announcement</label>
                    <select name="announcementTypeFilter" id="announcementTypeFilter">
                        <option value="all">All Announcements</option>
                        <option value="unionUpdate">SEIU HCPA Update</option>
                        <option value="chapterUpdate">Chapter Update</option>
                        <option value="facilityUpdate">Facility Update</option>
                        <option value="priorityUpdate">Priority</option>
                        <option value="negotiationUpdate">Bargaining Update</option>
                        <option value="socialActivity">Social Activities</option>
                    </select>
                    <br>

                    <button id="getAnnouncementsButton">Get Announcement</button>
                    <ul id="announcement-list"></ul>
                    </div>
    
                        </div>

                    </div>
                </div>
            

    <script type="module" src="app.js"></script>

    <script type="module">

        let currentUser = null;

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            setTimeout(() => {
                message.className = 'message';
            }, 5000);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'requests') {
                document.querySelector('[onclick="switchTab(\'requests\')"]').classList.add('active');
                document.getElementById('requestsTab').classList.add('active');
                loadRequests();
            } else if (tab === 'members') { 
                document.querySelector('[onclick="switchTab(\'members\')"]').classList.add('active');
                document.getElementById('membersTab').classList.add('active');
                loadMembers();
            }  else if (tab === 'announcements') { 
                document.querySelector('[onclick="switchTab(\'announcements\')"]').classList.add('active');
                document.getElementById('announcementsTab').classList.add('active');
            }
        }

        async function checkAdminAuth() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();

                if (data.authenticated && data.user.role === 'admin') {
                    currentUser = data.user;
                    document.getElementById('authRequired').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';
                    loadRequests();
                } else {
                    document.getElementById('authRequired').style.display = 'block';
                    document.getElementById('adminContent').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('authRequired').style.display = 'block';
                document.getElementById('adminContent').style.display = 'none';
            }
        }

        async function loadRequests() {
            try {
                const response = await fetch('/api/admin/access-requests');
                const data = await response.json();

                const requestsList = document.getElementById('requestsList');

                if (data.requests.length === 0) {
                    requestsList.innerHTML = '<div class="empty-state">No pending requests</div>';
                    return;
                }

                requestsList.innerHTML = data.requests.map(request => `
              <div class="card">
                <div class="card-header">
                  <div>
                    <h3>${request.name}</h3>
                    <p>üìß ${request.email}</p>
                    ${request.message ? `<p style="margin-top: 10px; font-style: italic;">"${request.message}"</p>` : ''}
                    <p style="margin-top: 10px; font-size: 12px; color: #999;">
                      Requested: ${new Date(request.created_at).toLocaleString()}
                    </p>
                  </div>
                  <span class="badge pending">Pending</span>
                </div>
                <div style="margin-top: 15px;">
                  <button class="btn-approve" onclick="approveRequest(${request.id}, '${request.name}')">
                    ‚úì Approve
                  </button>
                  <button class="btn-reject" onclick="rejectRequest(${request.id})">
                    ‚úó Reject
                  </button>
                </div>
              </div>
            `).join('');
            } catch (error) {
                showMessage('Error loading requests: ' + error.message, 'error');
            }
        }

        async function approveRequest(id, name) {
            if (!confirm(`Approve access for ${name}?`)) return;

            try {
                const response = await fetch(`/api/admin/approve-request/${id}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Member approved successfully!', 'success');
                    loadRequests();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error approving request', 'error');
            }
        }

        async function rejectRequest(id) {
            if (!confirm('Reject this access request?')) return;

            try {
                const response = await fetch(`/api/admin/reject-request/${id}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Request rejected', 'success');
                    loadRequests();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error rejecting request', 'error');
            }
        }

        async function loadMembers() {
            try {
                const response = await fetch('/api/admin/members');
                const data = await response.json();

                const tbody = document.getElementById('membersTableBody');

                tbody.innerHTML = data.members.map(member => `
              <tr>
                <td>${member.name}</td>
                <td>${member.email}</td>
                <td><span class="badge ${member.role}">${member.role}</span></td>
                <td><span class="badge ${member.status}">${member.status}</span></td>
                <td>${new Date(member.member_since).toLocaleDateString()}</td>
                <td>${member.last_login ? new Date(member.last_login).toLocaleDateString() : 'Never'}</td>
                <td>
                  ${member.id !== currentUser.id ? `
                    <button class="btn-toggle" onclick="toggleMemberStatus(${member.id}, '${member.status}', '${member.name}')">
                      ${member.status === 'active' ? 'Deactivate' : 'Activate'}
                    </button>
                    <button class="btn-delete" onclick="deleteMember(${member.id}, '${member.name}')">
                      Delete
                    </button>
                  ` : '<em style="color: #999;">You</em>'}
                </td>
              </tr>
            `).join('');
            } catch (error) {
                showMessage('Error loading members: ' + error.message, 'error');
            }
        }

        async function toggleMemberStatus(id, currentStatus, name) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';

            if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} ${name}?`)) return;

            try {
                const response = await fetch(`/api/admin/members/${id}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(`Member ${action}d successfully`, 'success');
                    loadMembers();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error updating member status', 'error');
            }
        }

        async function deleteMember(id, name) {
            if (!confirm(`Permanently delete ${name}? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/admin/members/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Member deleted successfully', 'success');
                    loadMembers();
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error deleting member', 'error');
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                showMessage('Error logging out', 'error');
            }
        }

        window.showMessage = showMessage;
        window.switchTab = switchTab;
        window.approveRequest=approveRequest;
        window.rejectRequest=rejectRequest;
        window.toggleMemberStatus=toggleMemberStatus;
        window.deleteMember=deleteMember;
        window.logout=logout;
        checkAdminAuth();
    </script>
    <script type="module">
        // Register service worker
 /**       if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }**/
    

        // Detect if app is installed
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA install prompt available');
            
        });

        // Detect if running as installed PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running as installed PWA');
        }


    </script>
</body>
</html>
